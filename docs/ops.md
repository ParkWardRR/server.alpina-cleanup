# Alpina Homelab Operations

Single source for network/host facts, access, IPv6 status, and app notes.

## Quick Links
- Firewall: OPNsense (gateway.alpina)
- DNS/Ad-block: Pi-hole (pihole.alpina)
- Monitoring: https://sentinella.alpina (Grafana/Prom/Loki/Alloy)
- Komga: http://komga.alpina (landing) / :25600 (UI)
- NTP: http://ntp.alpina (landing)
- Home Assistant: http://homeassistant.alpina:8123
- Remote Access: Tailscale subnet router via OPNsense (see docs/tailscale.md)

## Monitoring Stack (Sentinella)
- Grafana: https://grafana.sentinella.alpina — user `admin`, pass `sG8pF8JcGVl4BypmiPy/j06HgMcPda41`
- Prometheus / Loki / Alloy (basic auth): https://prometheus.sentinella.alpina, https://loki.sentinella.alpina, https://alloy.sentinella.alpina — user `admin`, pass `vURLumGa0GMu4/nR2+vejcenAQBqt1un`
- Syslog ingest: `sentinella.alpina:1514/udp`
- Manage: `sudo systemctl restart observability-stack` (on sentinella); configs under `/opt/observability/`
- Node Exporter: All 8 Linux/FreeBSD hosts scraped on `:9100` (gateway via `os-node_exporter` FreeBSD plugin).
- Pending Updates: Debian hosts use `apt_info.py` textfile collector (15min timer); AlmaLinux hosts use custom `dnf-updates-prom.sh` (15min cron). Dashboard shows per-host pending count + reboot required.
- Portocali NAS:
  - Logs: `portocali.alpina` forwards syslog-ng to Alloy (`1514/udp`)
  - Metrics: Prometheus SNMP Exporter scrapes Synology/Xpenology OIDs (disk/RAID/temp/services/I/O)
  - Alerts (Grafana): volume usage >85%/>90% + RAID/pool degraded (folder `Portocali`)

## Suricata IDS (OPNsense)
- **Version:** 6.0.15 in IDS mode (detect only, not IPS/blocking)
- **Interfaces:** LAN (`igb0`) + WAN (`igb3`)
- **Rule sets (~200K rules):**
  - abuse.ch: ThreatFox, URLhaus, SSL Blacklist, SSL IP Blacklist, Feodo Tracker
  - Emerging Threats Open: malware, phishing, exploit-kit, scan, JA3
  - Threat intel: botcc, botcc.portgrouped, ciarmy, compromised
- **EVE syslog:** Enabled — forwards alerts via OPNsense syslog-ng to Sentinella (`1514/udp`)
- **Community-ID:** Enabled in suricata.yaml (set in both config and template for persistence)
- **Dashboard:** Grafana Command Center has Suricata section with Alerts (1h/24h), Streams, Alert Rate, IDS Logs panels
- **Rules update:** Daily via OPNsense cron; `configctl ids update rules` to force manual update
- **Config files:**
  - OPNsense IDS config: `/conf/config.xml` (OPNsense/IDS section)
  - Suricata config: `/usr/local/etc/suricata/suricata.yaml` (regenerated by installRules.py)
  - Template: `/usr/local/opnsense/service/templates/OPNsense/IDS/suricata.yaml`
  - Custom overrides: `/usr/local/etc/suricata/custom.yaml`
  - Rule files: `/usr/local/etc/suricata/opnsense.rules/`
- **Firewall quiet rules:** Plex GDM (UDP 32412/32414 from 169.254.0.0/16) passed with logging disabled to reduce filterlog noise (~28K entries/day)
- **Note:** `emerging-trojan.rules` not available in ET Open (requires ET Pro subscription)

## Hosts

| Host | IPv4 | IPv6 | Role |
|------|------|------|------|
| gateway.alpina | 172.16.16.16 | 2603:8001:7400:fa9a:a236:9fff:fe66:27ac | OPNsense router/RA/DHCPv6-PD |
| pihole | 172.16.66.66 | 2603:8001:7400:fa9a:4392:b645:21ad:5510 | DNS/Ad-block, DHCPv4 (DHCPv6 disabled) |
| ntp.alpina | 172.16.16.108 | 2603:8001:7400:fa9a:be24:11ff:fe60:2dfe | Chrony NTP, landing page |
| komga.alpina | 172.16.16.202 | 2603:8001:7400:fa9a:be24:11ff:fe09:c0b9 | Komga media server |
| home.alpina | 172.16.17.109 | 2603:8001:7400:fa9a:be24:11ff:fec9:2694 | General purpose server |
| sentinella.alpina | 172.16.19.94 | 2603:8001:7400:fa9a:be24:11ff:fe95:2956 | Observability stack |
| aria.alpina | 172.16.18.230 | 2603:8001:7400:fa9a:eaff:1eff:fed3:4683 | Proxmox host |
| homeassistant.alpina | 172.16.77.77 | 2603:8001:7400:fa9a:d3e5:8d13:1bdd:2331 | HAOS appliance (Raspberry Pi 4); port 8123 on IPv6 |
| portocali.alpina | 172.16.21.21 | 2603:8001:7400:fa9a:7656:3cff:fe30:2dfc | NAS (Xpenology); SNMP metrics + syslog to Sentinella |

## SSH Access
```bash
ssh root@172.16.16.16                         # OPNsense
ssh pi@pihole                                  # Pi-hole
ssh alfa@ntp.alpina                            # NTP
ssh alfa@komga.alpina                          # Komga
ssh alfa@sentinella.alpina                     # Monitoring
ssh root@aria.alpina                           # Proxmox
ssh alfa@home.alpina                           # Home server
ssh alfa@portocali.alpina                      # NAS (Xpenology)
ssh root@homeassistant.local                   # Home Assistant (HAOS)
```

## IPv6 Status (as of 2026-02-06)
- Prefix: `2603:8001:7400:fa9a::/64` via DHCPv6-PD on OPNsense.
- OPNsense RAs: SLAAC + RDNSS (Pi-hole link-local) + DNSSL (alpina); firewall allows ICMPv6/NDP/DHCPv6.
- Pi-hole: dual-stack DNS; DHCPv6/RA **disabled** to stop rogue RAs.
- **All 9/9 hosts dual-stack:** gateway, pihole, ntp, komga, home, sentinella, aria, portocali, homeassistant — all with SLAAC.
- Outstanding: route-info-only RAs for ULA `fde6:19bd:3ffd::/64` from MACs `04:99:b9:71:36:9d`, `04:99:b9:84:18:17`, `ec:a9:07:07:22:bf`, `ac:bc:b5:db:26:fa` (identify/disable at source).
- Recent fixes (2026-02-06):
  - Proxmox: added `/etc/sysctl.d/50-ipv6.conf` with `accept_ra=2` (vmbr0/all); now has global address and internet v6 reachability.
  - home.alpina & sentinella.alpina: firewalld now allows `ipv6-icmp`; after clearing Pi-hole RA, single default via gateway and `ping -6` succeeds.
  - Pi-hole: `[dhcp] ipv6=false` in `pihole.toml`; restart FTL; no more default-route RAs from Pi-hole.
  - Portocali NAS: IPv6 enabled in DSM (`IPV6INIT=auto`, `accept_ra=2`, `autoconf=1`); SLAAC address `2603:...:fe30:2dfc` (EUI-64); default via gateway. Note: no services (SSH/SMB/NFS) listen on IPv6; DNS resolver is IPv4-only.
  - Sentinella: Observability stack (Caddy/Grafana/Prometheus/Loki/Alloy) now dual-stack; added `[::]:80/443/1514` port bindings and `enable_ipv6: true` on Podman network.
  - Home Assistant: HAOS already had IPv6 via NetworkManager/SLAAC; global address `2603:...:d3e5:8d13:1bdd:2331` (stable-privacy); gateway and DNS via RDNSS both correct; port 8123 accessible over IPv6; 9/9 hosts now dual-stack.

## Application Notes

### Komga (Debian 12, Docker)
- Status: Running Komga v1.24.1; NFS `/mnt/MonterosaSync-Read` mounted and persistent.
- Security: UFW enabled (SSH open; Komga 25600 limited to 172.16.0.0/16); SSH hardened; Fail2ban active; unattended-upgrades enabled.
- Access: http://komga.alpina (landing) and :25600 UI; SSH `alfa@komga.alpina`.
- Maintenance: reboot pending if new kernel installed; Komga auto-scans hourly; container restart policy `unless-stopped`.

### NTP (AlmaLinux 10) — Maximum Performance Build
- **Chrony 4.6.1** with NTS support; performance dashboard at http://ntp.alpina (Go binary, offset/drift/error/PLL charts with 1h-30d ranges, NTS auth table, reach visualization, source stats); node_exporter on 9100.
- **33 upstream sources:** 7 NTS-authenticated (Cloudflare, Netnod, 3x PTB Germany, 2x Glypnod) + 5x Google + 6x NIST + Facebook + Apple + Microsoft + 10 from pool
- **Polling:** minpoll 1 (2s) for Google/Meta, minpoll 2 (4s) for others; maxpoll 5-6 (32-64s)
- **Update interval:** ~6.7s (was 32.6s)
- **System accuracy:** ~7μs last offset, ~36μs system time offset (stratum 2)
- **Real-time scheduling:** SCHED_FIFO priority 99, nice -20, OOM-immune, memory-locked
- **Kernel tuning:** `/etc/sysctl.d/99-ntp-performance.conf` (16MB socket buffers, busy-poll, low-latency)
- **Systemd override:** `/etc/systemd/system/chronyd.service.d/performance.conf`
- **Clock discipline:** makestep 0.1s/5, rtcsync (kernel 11-min RTC mode), maxupdateskew 5.0, maxdistance 0.5
- **Leap seconds:** right/UTC timezone, slew mode, maxslewrate 1000 ppm
- **Client access:** 172.16.0.0/16, 10.0.0.0/8, 2603:8001:7400::/44, fe80::/10; rate-limited
- **Dashboard:** Grafana Command Center NTP section with Clock Offset (μs), Sync Status, Frequency Drift, Max Error (μs), Estimated Error (μs), NTP Config info, Clock Offset History, NTP Health Logs, NTP Error History, Frequency Drift History, PLL Time Constant (12 panels)
- **Backups:** `/var/backups/ntp/pre-remediation-20260127_132804.tar.gz`, `/etc/chrony.conf.bak.20260206`

### Pi-hole (v6)
- Upstreams: Quad9, Cloudflare, Google (IPv4+IPv6); `listeningMode=ALL`; `blockingmode=null`.
- Custom AAAA records added (core hosts) in `/etc/pihole/custom.list`; AAAA for `gateway.alpina` and service subdomains may be affected by known FTL bug.

### Backups
- OPNsense: `/root/ipv6-backup-20260205_213520/` (config, radvd, dhcp6c, rules, ndp snapshot).
- Pi-hole: `/home/pi/ipv6-backup-20260205_213526/` (pihole.toml, custom.list, sysctl, route snapshots).

### Monitoring: Update Metrics
- **Debian hosts** (pihole, komga, aria): `prometheus-node-exporter-collectors` package provides `apt_upgrades_pending` and `node_reboot_required` via systemd timer (every 15 min).
- **AlmaLinux hosts** (sentinella, ntp, home): Custom `/usr/local/bin/dnf-updates-prom.sh` writes `yum_upgrades_pending` and `node_reboot_required` to textfile collector; cron `/etc/cron.d/prom-dnf` (every 15 min); node_exporter flag `--collector.textfile.directory=/var/lib/node_exporter/textfile`.
- **OPNsense** (gateway): `os-node_exporter` plugin installed; `service node_exporter enable/start`; scraped at `172.16.16.16:9100`.

### Open Actions
- Identify devices sending ULA route-info RAs; disable RA on those MACs.
- ~~Add HAOS IPv6~~ — resolved; HAOS already had working IPv6 via SLAAC.
- Add AAAA record for `portocali.alpina` in Pi-hole custom.list.
- Optional: request /56 PD from ISP (may change prefix; plan renumbering beforehand).
- Monitor Suricata IDS alerts for 2-3 weeks; tune false positives before considering IPS mode.
- Consider upgrading OPNsense to get Suricata 7.x (better performance, HTTP/2 support).
